<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= title %> | Vinyl Vault</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"
    />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link rel="stylesheet" href="/styles.css" />
    <link rel="stylesheet" href="/stylesheets/nav.css" />
    <link rel="stylesheet" href="/stylesheets/notifications.css" />
  </head>
  <body>
    <script src="/javascripts/theme.js"></script>
    <nav class="main-nav">
      <div class="nav-content">
        <a href="<%= user ? '/records' : '/' %>" class="nav-logo">Vinyl Vault</a>
        <button class="mobile-menu-toggle hide-on-large-only">
          <i class="material-icons">menu</i>
        </button>
        <% if (user) { %>
        <!-- Desktop Navigation -->
        <div class="nav-links hide-on-med-and-down">
          <a href="/records">
            <i class="material-icons">album</i>Collection
          </a>
          <a href="/records/stats">
            <i class="material-icons">bar_chart</i>Stats
          </a>
          <!-- Add Record Dropdown -->
          <a class="dropdown-trigger" href="#" data-target="add-record-dropdown">
            <i class="material-icons">add</i>Add Record<i class="material-icons right">arrow_drop_down</i>
          </a>
          <a href="/stores/nearby">
            <i class="material-icons">store</i>Stores
          </a>
          <a href="/search">
            <i class="material-icons">group</i>Users
          </a>
          <a href="/blog">
            <i class="material-icons">article</i>Blog
          </a>
          <a href="/forum">
            <i class="material-icons">forum</i>Forum
          </a>
          <!-- Notifications Dropdown -->
          <div class="notifications-nav">
            <a href="#" class="dropdown-trigger notifications-trigger" data-target="notifications-dropdown">
              <i class="material-icons">notifications</i>
              <% if (locals.unreadNotifications > 0) { %>
                <span class="notification-badge"><%= locals.unreadNotifications %></span>
              <% } %>
            </a>
            <ul id="notifications-dropdown" class="dropdown-content notifications-dropdown">
              <li class="notifications-header">
                <span>Notifications</span>
                <a href="/notifications" class="view-all">View All</a>
              </li>
              <% if (locals.recentNotifications?.length > 0) { %>
                <% locals.recentNotifications.forEach(notification => { %>
                  <li>
                    <a href="<%= notification.link %>" class="notification-item <%= notification.read ? '' : 'unread' %>">
                      <% if (notification.sender) { %>
                        <img src="<%= notification.sender.profile?.avatarUrl || '/images/default-avatar.png' %>" 
                             alt="Avatar" class="notification-avatar">
                      <% } else { %>
                        <i class="material-icons notification-icon">
                          <%= notification.type === 'price_alert' ? 'trending_up' : 
                              notification.type === 'milestone' ? 'emoji_events' : 'notifications' %>
                        </i>
                      <% } %>
                      <div class="notification-content">
                        <div class="notification-message"><%= notification.message %></div>
                        <time class="timeago" datetime="<%= notification.createdAt.toISOString() %>">
                          <%= notification.createdAt.toLocaleDateString() %>
                        </time>
                      </div>
                    </a>
                  </li>
                <% }); %>
              <% } else { %>
                <li class="no-notifications">
                  <i class="material-icons">notifications_none</i>
                  <span>No new notifications</span>
                </li>
              <% } %>
            </ul>
          </div>
          <% if (user.isAdmin) { %>
            <a href="/blog/admin/featured">
              <i class="material-icons">featured_play_list</i>Featured
            </a>
          <% } %>
          <div class="user-menu">
            <a class="dropdown-trigger" href="#" data-target="user-dropdown">
              <img
                src="<%= user.profile?.avatarUrl || '/images/default-avatar.png' %>"
                alt="Avatar"
                class="user-avatar"
              />
              <%= user.profile?.name || user.username %>
              <i class="material-icons right">arrow_drop_down</i>
            </a>
          </div>
        </div>

        <!-- Mobile Navigation -->
        <div class="nav-links hide-on-large-only mobile-nav">
          <div class="mobile-user-info">
            <img
              src="<%= user.profile?.avatarUrl || '/images/default-avatar.png' %>"
              alt="Avatar"
              class="user-avatar"
            />
            <span><%= user.profile?.name || user.username %></span>
          </div>
          <div class="mobile-nav-links">
            <a href="/records">
              <i class="material-icons">album</i>My Collection
            </a>
            <a href="/records/stats">
              <i class="material-icons">bar_chart</i>Stats
            </a>
            <!-- Add Record Options -->
            <a href="/records/new">
              <i class="material-icons">add_circle</i>Add Manually
            </a>
            <a href="/records/search">
              <i class="material-icons">album</i>Import from Discogs
            </a>
            <a href="/stores/nearby">
              <i class="material-icons">store</i>Find Stores
            </a>
            <a href="/search">
              <i class="material-icons">group</i>Find Users
            </a>
            <a href="/blog">
              <i class="material-icons">article</i>Blog
            </a>
            <a href="/forum">
              <i class="material-icons">forum</i>Forum
            </a>
            <a href="/notifications">
              <i class="material-icons">notifications</i>Notifications
              <% if (locals.unreadNotifications > 0) { %>
                <span class="mobile-notification-badge"><%= locals.unreadNotifications %></span>
              <% } %>
            </a>
            <% if (user.isAdmin) { %>
              <a href="/blog/admin/featured">
                <i class="material-icons">featured_play_list</i>Featured Records
              </a>
            <% } %>
            <div class="divider"></div>
            <a href="/records/profile">
              <i class="material-icons">person</i>View Profile
            </a>
            <a href="/records/settings">
              <i class="material-icons">settings</i>Settings
            </a>
            <a href="/auth/sign-out">
              <i class="material-icons">exit_to_app</i>Sign Out
            </a>
          </div>
        </div>

        <!-- Add Record dropdown structure -->
        <ul id="add-record-dropdown" class="dropdown-content">
          <li>
            <a href="/records/new">
              <i class="material-icons">add_circle</i>Add Manually
            </a>
          </li>
          <li>
            <a href="/records/search">
              <i class="material-icons">album</i>Import from Discogs
            </a>
          </li>
        </ul>

        <!-- User dropdown structure -->
        <ul id="user-dropdown" class="dropdown-content user-dropdown">
          <li>
            <a href="/records/profile">
              <i class="material-icons">person</i>View Profile
            </a>
          </li>
          <li>
            <a href="/records/settings">
              <i class="material-icons">settings</i>Settings
            </a>
          </li>
          <li class="divider"></li>
          <li>
            <a href="/auth/sign-out">
              <i class="material-icons">exit_to_app</i>Sign Out
            </a>
          </li>
        </ul>
        <% } else { %>
        <div class="nav-links">
          <a href="/auth/sign-in">Sign In</a>
        </div>
        <% } %>
        <div class="switch">
            <label>
                ðŸŒž
                <input type="checkbox" id="darkModeToggle">
                <span class="lever"></span>
                ðŸŒ™
            </label>
        </div>
      </div>
    </nav>
    <main class="main-content"></main>
    
    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Initialize dropdowns
        var dropdowns = document.querySelectorAll('.dropdown-trigger');
        M.Dropdown.init(dropdowns, {
          constrainWidth: false,
          coverTrigger: false
        });
        
        // Initialize collapsibles
        var collapsibles = document.querySelectorAll('.collapsible');
        M.Collapsible.init(collapsibles);

        // Mobile menu toggle
        const mobileMenuToggle = document.querySelector('.mobile-menu-toggle');
        const mobileNav = document.querySelector('.mobile-nav');
        
        if (mobileMenuToggle && mobileNav) {
          mobileMenuToggle.addEventListener('click', function() {
            mobileNav.classList.toggle('active');
            const icon = this.querySelector('i');
            icon.textContent = mobileNav.classList.contains('active') ? 'close' : 'menu';
            
            // Prevent body scroll when menu is open
            document.body.style.overflow = mobileNav.classList.contains('active') ? 'hidden' : '';
          });

          // Close mobile menu when clicking outside
          document.addEventListener('click', function(event) {
            if (!mobileNav.contains(event.target) && 
                !mobileMenuToggle.contains(event.target) && 
                mobileNav.classList.contains('active')) {
              mobileNav.classList.remove('active');
              mobileMenuToggle.querySelector('i').textContent = 'menu';
              document.body.style.overflow = '';
            }
          });

          // Close mobile menu when clicking a link
          mobileNav.querySelectorAll('a').forEach(link => {
            link.addEventListener('click', () => {
              mobileNav.classList.remove('active');
              mobileMenuToggle.querySelector('i').textContent = 'menu';
              document.body.style.overflow = '';
            });
          });
        }
      });
    </script>
  </body>
</html>
