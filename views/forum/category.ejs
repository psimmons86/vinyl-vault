<%- include('../partials/header') %>

<div class="container">
    <div class="row">
        <div class="col s12">
            <!-- Category Header -->
            <div class="forum-header">
                <div class="breadcrumbs">
                    <a href="/forum">Forum</a>
                    <i class="material-icons tiny">chevron_right</i>
                    <span><%= category.name %></span>
                </div>
                <% if (user) { %>
                    <a href="/forum/new-topic/<%= category.slug %>" class="btn waves-effect waves-light">
                        <i class="material-icons left">add</i>
                        New Topic
                    </a>
                <% } %>
            </div>

            <!-- Category Info -->
            <div class="card forum-category">
                <div class="card-content">
                    <div class="category-header">
                        <div class="category-icon">
                            <i class="material-icons"><%= category.icon %></i>
                        </div>
                        <div class="category-info">
                            <h1 class="category-title"><%= category.name %></h1>
                            <p class="category-description grey-text">
                                <%= category.description %>
                            </p>
                        </div>
                        <div class="category-stats">
                            <div class="stat">
                                <span class="stat-number"><%= category.topicCount %></span>
                                <span class="stat-label">Topics</span>
                            </div>
                            <div class="stat">
                                <span class="stat-number"><%= category.postCount %></span>
                                <span class="stat-label">Posts</span>
                            </div>
                        </div>
                    </div>

                    <% if (category.moderators?.length > 0) { %>
                        <div class="category-moderators">
                            <span class="grey-text">Moderators:</span>
                            <% category.moderators.forEach((mod, i) => { %>
                                <a href="/records/profile/<%= mod.username %>">
                                    <%= mod.profile?.name || mod.username %>
                                </a>
                                <%= i < category.moderators.length - 1 ? ',' : '' %>
                            <% }); %>
                        </div>
                    <% } %>
                </div>
            </div>

            <!-- Topics List -->
            <div class="card">
                <div class="card-content">
                    <div class="topic-list collection">
                        <% if (topics.length === 0) { %>
                            <div class="collection-item center-align">
                                <p class="grey-text">No topics yet. Be the first to start a discussion!</p>
                                <% if (user) { %>
                                    <a href="/forum/new-topic/<%= category.slug %>" class="btn waves-effect waves-light">
                                        <i class="material-icons left">add</i>
                                        New Topic
                                    </a>
                                <% } %>
                            </div>
                        <% } else { %>
                            <% topics.forEach(topic => { %>
                                <div class="collection-item">
                                    <div class="topic-info">
                                        <% if (topic.isPinned) { %>
                                            <i class="material-icons tiny" title="Pinned Topic">push_pin</i>
                                        <% } %>
                                        <a href="/forum/topic/<%= topic.slug %>" class="topic-title">
                                            <%= topic.title %>
                                        </a>
                                        <div class="topic-meta">
                                            Started by 
                                            <a href="/records/profile/<%= topic.author.username %>">
                                                <%= topic.author.profile?.name || topic.author.username %>
                                            </a>
                                            • <%= new Date(topic.createdAt).toLocaleDateString() %>
                                            <% if (topic.tags?.length > 0) { %>
                                                • 
                                                <% topic.tags.forEach(tag => { %>
                                                    <span class="chip"><%= tag %></span>
                                                <% }); %>
                                            <% } %>
                                        </div>
                                    </div>
                                    <div class="topic-stats">
                                        <div class="stat">
                                            <span class="stat-number"><%= topic.postCount %></span>
                                            <span class="stat-label">Replies</span>
                                        </div>
                                        <div class="stat">
                                            <span class="stat-number"><%= topic.views %></span>
                                            <span class="stat-label">Views</span>
                                        </div>
                                    </div>
                                    <% if (topic.lastPost?.user) { %>
                                        <div class="last-post-info">
                                            <small class="grey-text">Last reply by</small><br>
                                            <a href="/records/profile/<%= topic.lastPost.user.username %>">
                                                <%= topic.lastPost.user.profile?.name || topic.lastPost.user.username %>
                                            </a>
                                            <br>
                                            <small class="grey-text">
                                                <%= new Date(topic.lastPost.createdAt).toLocaleDateString() %>
                                            </small>
                                        </div>
                                    <% } %>
                                </div>
                            <% }); %>
                        <% } %>
                    </div>
                </div>
            </div>

            <!-- Pagination -->
            <% if (pagination.pageCount > 1) { %>
                <div class="pagination center-align">
                    <ul class="pagination">
                        <% if (pagination.page > 1) { %>
                            <li>
                                <a href="?page=<%= pagination.page - 1 %>" class="waves-effect">
                                    <i class="material-icons">chevron_left</i>
                                </a>
                            </li>
                        <% } %>

                        <% for (let i = 1; i <= pagination.pageCount; i++) { %>
                            <li class="<%= pagination.page === i ? 'active' : 'waves-effect' %>">
                                <a href="?page=<%= i %>"><%= i %></a>
                            </li>
                        <% } %>

                        <% if (pagination.page < pagination.pageCount) { %>
                            <li>
                                <a href="?page=<%= pagination.page + 1 %>" class="waves-effect">
                                    <i class="material-icons">chevron_right</i>
                                </a>
                            </li>
                        <% } %>
                    </ul>
                </div>
            <% } %>
        </div>
    </div>
</div>

<%- include('../partials/footer') %>
