<%- include('../../partials/header') %>

<div class="container section">
    <div class="row">
        <div class="col s12">
            <div class="header-section">
                <h4>Heavy Rotation</h4>
                <div class="action-buttons">
                    <button class="btn waves-effect waves-light blue modal-trigger" 
                            data-target="addRecordModal">
                        <i class="fas fa-plus left"></i> Add Record
                    </button>
                    <button class="btn waves-effect waves-light green modal-trigger" 
                            data-target="searchDiscogsModal">
                        <i class="fas fa-search left"></i> Search Discogs
                    </button>
                </div>
            </div>

            <% if (featured && featured.length > 0) { %>
                <div class="featured-records">
                    <% featured.forEach(record => { %>
                        <div class="card horizontal" data-record-id="<%= record._id %>">
                            <div class="card-image">
                                <img src="<%= record.albumArt %>" alt="<%= record.title %>">
                            </div>
                            <div class="card-stacked">
                                <div class="card-content">
                                    <span class="card-title"><%= record.title %></span>
                                    <p class="artist grey-text"><%= record.artist %></p>
                                    <% if (record.description) { %>
                                        <p class="description"><%= record.description %></p>
                                    <% } %>
                                    <% if (record.link) { %>
                                        <p class="link">
                                            <a href="<%= record.link %>" target="_blank" class="blue-text">
                                                <i class="fas fa-external-link-alt"></i> View Record
                                            </a>
                                        </p>
                                    <% } %>
                                </div>
                                <div class="card-action">
                                    <div class="order-controls">
                                        <select class="order-select browser-default" 
                                                data-record-id="<%= record._id %>">
                                            <% for(let i = 1; i <= 5; i++) { %>
                                                <option value="<%= i %>" 
                                                        <%= record.order === i ? 'selected' : '' %>>
                                                    Position <%= i %>
                                                </option>
                                            <% } %>
                                        </select>
                                    </div>
                                    <div class="action-buttons">
                                        <button class="btn-flat waves-effect waves-blue edit-btn" 
                                                data-record-id="<%= record._id %>"
                                                data-title="<%= record.title %>"
                                                data-artist="<%= record.artist %>"
                                                data-description="<%= record.description || '' %>"
                                                data-link="<%= record.link || '' %>"
                                                data-order="<%= record.order %>">
                                            <i class="fas fa-edit blue-text"></i>
                                        </button>
                                        <button class="btn-flat waves-effect waves-red remove-btn" 
                                                data-record-id="<%= record._id %>">
                                            <i class="fas fa-trash red-text"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    <% }); %>
                </div>
            <% } else { %>
                <div class="card-panel">
                    <p>No featured records yet. Add up to 5 records to display in the Heavy Rotation section.</p>
                </div>
            <% } %>
        </div>
    </div>
</div>

<!-- Add/Edit Record Modal -->
<div id="addRecordModal" class="modal">
    <form action="/blog/admin/featured" method="POST" enctype="multipart/form-data" id="featuredForm">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        <input type="hidden" name="_method" id="formMethod" value="POST">
        <input type="hidden" name="recordId" id="recordId" value="">
        <div class="modal-content">
            <h4 id="modalTitle">Add Featured Record</h4>
            
            <div class="row">
                <div class="input-field col s12">
                    <input type="text" id="title" name="title" required>
                    <label for="title">Album Title</label>
                </div>

                <div class="input-field col s12">
                    <input type="text" id="artist" name="artist" required>
                    <label for="artist">Artist</label>
                </div>

                <div class="file-field input-field col s12">
                    <div class="btn blue">
                        <span>Album Art</span>
                        <input type="file" name="albumArt" accept="image/*" id="albumArt">
                    </div>
                    <div class="file-path-wrapper">
                        <input class="file-path validate" type="text">
                    </div>
                </div>

                <div class="input-field col s12">
                    <textarea id="description" name="description" 
                              class="materialize-textarea"></textarea>
                    <label for="description">Description (optional)</label>
                </div>

                <div class="input-field col s12">
                    <input type="url" id="link" name="link">
                    <label for="link">Link to Record (optional)</label>
                </div>

                <div class="input-field col s12">
                    <select name="order" required>
                        <% for(let i = 1; i <= 5; i++) { %>
                            <option value="<%= i %>">Position <%= i %></option>
                        <% } %>
                    </select>
                    <label>Display Order</label>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="submit" class="btn waves-effect waves-light blue">
                <i class="fas fa-save left"></i> <span id="submitText">Add Record</span>
            </button>
            <button type="button" class="btn-flat waves-effect modal-close">
                Cancel
            </button>
        </div>
    </form>
</div>

<!-- Search Discogs Modal -->
<div id="searchDiscogsModal" class="modal modal-fixed-footer">
    <div class="modal-content">
        <h4>Search Discogs</h4>
        
        <div class="row">
            <form id="discogsSearchForm" class="col s12">
                <div class="input-field">
                    <input type="text" id="discogsQuery" required>
                    <label for="discogsQuery">Search for albums</label>
                </div>
                <button type="submit" class="btn waves-effect waves-light blue">
                    <i class="fas fa-search left"></i> Search
                </button>
            </form>
        </div>
        
        <div id="searchResults" class="row">
            <!-- Search results will be displayed here -->
        </div>
    </div>
    <div class="modal-footer">
        <button class="btn-flat waves-effect modal-close">Close</button>
    </div>
</div>

<style>
.header-section {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.header-section .action-buttons {
    display: flex;
    gap: 0.5rem;
}

.featured-records {
    margin-top: 2rem;
}

.featured-records .card.horizontal {
    margin: 1rem 0;
}

.featured-records .card-image {
    max-width: 150px;
    min-width: 150px;
    height: 150px;
}

.featured-records .card-image img {
    height: 100%;
    object-fit: cover;
}

.card-action {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.order-controls {
    flex: 1;
    margin-right: 1rem;
}

.order-select {
    width: 200px;
}

.description {
    margin: 1rem 0;
    color: #666;
}

/* Discogs search results styling */
#searchResults .col {
    margin-bottom: 15px;
}

.search-result-card {
    display: flex;
    background-color: #f5f5f5;
    border-radius: 4px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    height: 100%;
    padding: 15px;
}

.dark-mode .search-result-card {
    background-color: #333;
}

.search-result-image {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 4px;
    margin-right: 15px;
}

.search-result-info {
    flex: 1;
    display: flex;
    flex-direction: column;
}

.search-result-title {
    font-size: 1.1rem;
    font-weight: 500;
    margin: 0 0 5px 0;
    color: #333;
}

.dark-mode .search-result-title {
    color: #fff;
}

.search-result-artist {
    font-size: 0.9rem;
    color: #666;
    margin: 0 0 5px 0;
}

.dark-mode .search-result-artist {
    color: #aaa;
}

.search-result-year {
    font-size: 0.8rem;
    color: #999;
    margin: 0 0 10px 0;
}

.search-result-info .btn {
    margin-top: auto;
    align-self: flex-start;
}

@media (max-width: 600px) {
    .header-section {
        flex-direction: column;
        gap: 1rem;
    }
    
    .featured-records .card.horizontal {
        display: block;
    }
    
    .featured-records .card-image {
        max-width: none;
        height: 200px;
    }
    
    .card-action {
        flex-direction: column;
        gap: 1rem;
    }
    
    .order-controls {
        width: 100%;
        margin-right: 0;
    }
    
    .order-select {
        width: 100%;
    }
    
    .search-result-card {
        flex-direction: column;
    }
    
    .search-result-image {
        width: 100%;
        height: 120px;
        margin-right: 0;
        margin-bottom: 10px;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('featuredForm');
    const modalTitle = document.getElementById('modalTitle');
    const submitText = document.getElementById('submitText');
    const formMethod = document.getElementById('formMethod');
    const recordIdInput = document.getElementById('recordId');
    const albumArtInput = document.getElementById('albumArt');
    const discogsSearchForm = document.getElementById('discogsSearchForm');
    const searchResults = document.getElementById('searchResults');

    // Initialize Materialize components
    const modals = document.querySelectorAll('.modal');
    M.Modal.init(modals, {
        dismissible: true,
        opacity: 0.5,
        inDuration: 300,
        outDuration: 200
    });
    
    M.FormSelect.init(document.querySelectorAll('select'));
    M.textareaAutoResize(document.querySelector('#description'));

    // Handle order changes
    document.querySelectorAll('.order-select').forEach(select => {
        select.addEventListener('change', async function() {
            const recordId = this.dataset.recordId;
            const newOrder = this.value;
            
            try {
                const response = await fetch(`/blog/admin/featured/${recordId}/order`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ order: newOrder })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    M.toast({html: 'Order updated'});
                    setTimeout(() => window.location.reload(), 500);
                } else {
                    throw new Error(data.error || 'Error updating order');
                }
            } catch (error) {
                console.error('Error:', error);
                M.toast({html: error.message || 'Error updating order'});
                // Reset select to previous value
                this.value = this.querySelector('[selected]').value;
            }
        });
    });

    // Handle edit button clicks
    document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const modal = M.Modal.getInstance(document.getElementById('addRecordModal'));
            const data = this.dataset;
            
            // Update form for editing
            modalTitle.textContent = 'Edit Featured Record';
            submitText.textContent = 'Update Record';
            formMethod.value = 'PUT';
            recordIdInput.value = data.recordId;
            
            // Fill form fields
            document.getElementById('title').value = data.title;
            document.getElementById('artist').value = data.artist;
            document.getElementById('description').value = data.description;
            document.getElementById('link').value = data.link;
            document.querySelector('select[name="order"]').value = data.order;
            
            // Make album art optional for editing
            albumArtInput.removeAttribute('required');
            
            // Update Materialize form fields
            M.updateTextFields();
            M.textareaAutoResize(document.getElementById('description'));
            
            modal.open();
        });
    });

    // Reset form when adding new record
    document.querySelector('[data-target="addRecordModal"]').addEventListener('click', function() {
        modalTitle.textContent = 'Add Featured Record';
        submitText.textContent = 'Add Record';
        formMethod.value = 'POST';
        recordIdInput.value = '';
        form.reset();
        albumArtInput.setAttribute('required', '');
    });

    // Handle record removal
    document.querySelectorAll('.remove-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            if (!confirm('Are you sure you want to remove this record?')) return;
            
            const recordId = this.dataset.recordId;
            const card = document.querySelector(`[data-record-id="${recordId}"]`);
            
            try {
                const response = await fetch(`/blog/admin/featured/${recordId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    M.toast({html: 'Record removed'});
                    card.style.opacity = '0';
                    setTimeout(() => {
                        card.remove();
                        if (document.querySelectorAll('.featured-records .card').length === 0) {
                            window.location.reload();
                        }
                    }, 300);
                } else {
                    throw new Error(data.error || 'Error removing record');
                }
            } catch (error) {
                console.error('Error:', error);
                M.toast({html: error.message || 'Error removing record'});
            }
        });
    });

    // Handle Discogs search
    discogsSearchForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const query = document.getElementById('discogsQuery').value.trim();
        
        if (!query) return;
        
        searchResults.innerHTML = '<div class="progress"><div class="indeterminate"></div></div>';
        
        try {
            const response = await fetch(`/blog/admin/featured/search-discogs?q=${encodeURIComponent(query)}`);
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            if (data.results && data.results.length > 0) {
                let resultsHTML = '';
                
                data.results.forEach(result => {
                    resultsHTML += `
                        <div class="col s12 m6 l4">
                            <div class="search-result-card">
                                <img src="${result.thumb}" alt="${result.title}" class="search-result-image">
                                <div class="search-result-info">
                                    <div class="search-result-title truncate" title="${result.title}">${result.title}</div>
                                    <div class="search-result-artist truncate" title="${result.artist}">${result.artist}</div>
                                    <div class="search-result-year">${result.year || 'Unknown year'}</div>
                                    <button class="btn waves-effect waves-light blue add-from-discogs" 
                                            data-release-id="${result.id}">
                                        Add
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                searchResults.innerHTML = resultsHTML;
                
                // Add event listeners to the "Add" buttons
                document.querySelectorAll('.add-from-discogs').forEach(btn => {
                    btn.addEventListener('click', async function() {
                        const releaseId = this.dataset.releaseId;
                        this.disabled = true;
                        this.textContent = 'Adding...';
                        
                        try {
                            const response = await fetch('/blog/admin/featured/add-from-discogs', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ releaseId })
                            });
                            
                            const data = await response.json();
                            
                            if (data.success) {
                                M.toast({html: 'Record added to heavy rotation'});
                                setTimeout(() => window.location.reload(), 1000);
                            } else {
                                throw new Error(data.error || 'Error adding record');
                            }
                        } catch (error) {
                            console.error('Error:', error);
                            M.toast({html: error.message || 'Error adding record'});
                            this.disabled = false;
                            this.textContent = 'Add';
                        }
                    });
                });
            } else {
                searchResults.innerHTML = '<div class="col s12"><div class="card-panel">No results found</div></div>';
            }
        } catch (error) {
            console.error('Error:', error);
            searchResults.innerHTML = `<div class="col s12"><div class="card-panel red lighten-4 red-text text-darken-4">Error: ${error.message || 'Failed to search Discogs'}</div></div>`;
        }
    });
});
</script>

<%- include('../../partials/footer') %>
